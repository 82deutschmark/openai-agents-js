---
title: 音声エージェントの構築
description: Learn how to build voice agents using the OpenAI Agents SDK, what features are available, how to architecture your application, and more.
---

import { Steps, Aside, Code } from '@astrojs/starlight/components';
import createAgentExample from '../../../../../../../examples/docs/voice-agents/createAgent.ts?raw';
import multiAgentsExample from '../../../../../../../examples/docs/voice-agents/multiAgents.ts?raw';
import createSessionExample from '../../../../../../../examples/docs/voice-agents/createSession.ts?raw';
import configureSessionExample from '../../../../../../../examples/docs/voice-agents/configureSession.ts?raw';
import handleAudioExample from '../../../../../../../examples/docs/voice-agents/handleAudio.ts?raw';
import defineToolExample from '../../../../../../../examples/docs/voice-agents/defineTool.ts?raw';
import toolApprovalEventExample from '../../../../../../../examples/docs/voice-agents/toolApprovalEvent.ts?raw';
import guardrailsExample from '../../../../../../../examples/docs/voice-agents/guardrails.ts?raw';
import guardrailSettingsExample from '../../../../../../../examples/docs/voice-agents/guardrailSettings.ts?raw';
import audioInterruptedExample from '../../../../../../../examples/docs/voice-agents/audioInterrupted.ts?raw';
import sessionInterruptExample from '../../../../../../../examples/docs/voice-agents/sessionInterrupt.ts?raw';
import sessionHistoryExample from '../../../../../../../examples/docs/voice-agents/sessionHistory.ts?raw';
import historyUpdatedExample from '../../../../../../../examples/docs/voice-agents/historyUpdated.ts?raw';
import updateHistoryExample from '../../../../../../../examples/docs/voice-agents/updateHistory.ts?raw';
import customWebRTCTransportExample from '../../../../../../../examples/docs/voice-agents/customWebRTCTransport.ts?raw';
import websocketSessionExample from '../../../../../../../examples/docs/voice-agents/websocketSession.ts?raw';
import transportEventsExample from '../../../../../../../examples/docs/voice-agents/transportEvents.ts?raw';
import thinClientExample from '../../../../../../../examples/docs/voice-agents/thinClient.ts?raw';
import toolHistoryExample from '../../../../../../../examples/docs/voice-agents/toolHistory.ts?raw';
import sendMessageExample from '../../../../../../../examples/docs/voice-agents/sendMessage.ts?raw';
import serverAgentExample from '../../../../../../../examples/docs/voice-agents/serverAgent.ts?raw';
import delegationAgentExample from '../../../../../../../examples/docs/voice-agents/delegationAgent.ts?raw';
import turnDetectionExample from '../../../../../../../examples/docs/voice-agents/turnDetection.ts?raw';

## 音声の取り扱い

デフォルトの `OpenAIRealtimeWebRTC` のような一部のトランスポートレイヤーは、音声の入出力を自動で処理します。`OpenAIRealtimeWebSocket` のような他のトランスポート機構では、セッション音声を自分で処理する必要があります。

<Code lang="typescript" code={handleAudioExample} />

## セッション設定

[`RealtimeSession`](/openai-agents-js/openai/agents-realtime/classes/realtimesession/) の構築時、または `connect(...)` を呼び出す際に追加のオプションを渡すことで、セッションを設定できます。

<Code lang="typescript" code={configureSessionExample} />

これらのトランスポートレイヤーでは、[session](https://platform.openai.com/docs/api-reference/realtime-client-events/session/update) に一致する任意のパラメーターを渡せます。

[RealtimeSessionConfig](/openai-agents-js/openai/agents-realtime/type-aliases/realtimesessionconfig/) に一致するパラメーターがまだ存在しない新しいパラメーターについては、`providerData` を使えます。`providerData` に渡したものは `session` オブジェクトの一部としてそのまま渡されます。

## ハンドオフ

通常の エージェント と同様に、ハンドオフ を使ってエージェントを複数の エージェント に分割し、それらの間をオーケストレーションすることで、エージェントのパフォーマンス改善や問題のスコープを適切に絞り込むことができます。

<Code lang="typescript" code={multiAgentsExample} />

通常の エージェント と異なり、Realtime Agents ではハンドオフの動作が少し異なります。ハンドオフが実行されると、進行中のセッションは新しいエージェント設定で更新されます。そのため、エージェントは進行中の会話履歴に自動的にアクセスでき、現在は入力フィルターは適用されません。

さらに、これによりハンドオフの一部として `voice` や `model` を変更することはできません。接続できるのは他の Realtime Agents のみです。たとえば `gpt-5-mini` のような推論モデルなど別のモデルを使う必要がある場合は、[delegation through tools](#delegation-through-tools) を使用してください。

## ツール

通常の エージェント と同様に、Realtime Agents はアクション実行のためにツールを呼び出せます。通常のエージェントで使うのと同じ `tool()` 関数でツールを定義できます。

<Code lang="typescript" code={defineToolExample} />

Realtime Agents では使用できるのは 関数ツール のみで、これらのツールは Realtime Session と同じ場所で実行されます。つまりブラウザで Realtime Session を実行している場合、ツールもブラウザで実行されます。より機微なアクションを行う必要がある場合は、ツール内でバックエンド サーバー への HTTP リクエストを行ってください。

ツール実行中は、エージェントは ユーザー からの新規リクエストを処理できません。体験を改善する一つの方法は、ツールを実行しようとしていることをエージェントにアナウンスさせたり、ツール実行の時間稼ぎとなる特定のフレーズを言わせるように指示することです。

### 会話履歴へのアクセス

エージェントが特定のツールを呼び出す際の引数に加えて、Realtime Session が追跡している現在の会話履歴のスナップショットにもアクセスできます。これは、会話の現在の状態に基づいてより複雑なアクションを実行する必要がある場合や、[tools for delegation](#delegation-through-tools) を使用する予定がある場合に役立ちます。

<Code lang="typescript" code={toolHistoryExample} />

<Aside type="note">
  渡される履歴は、ツール呼び出し時点のスナップショットです。
  ユーザーが直前に話した内容の書き起こしが、まだ利用できない場合があります。
</Aside>

### ツール実行前の承認

ツールを `needsApproval: true` で定義すると、エージェントはツールを実行する前に `tool_approval_requested` イベントを発行します。

このイベントをリッスンして、ツール呼び出しを承認または拒否するための UI を ユーザー に表示できます。

<Code lang="typescript" code={toolApprovalEventExample} />

<Aside type="note">
  音声エージェントがツール呼び出しの承認を待っている間、エージェントは ユーザー
  からの新規リクエストを処理できません。
</Aside>

## ガードレール

ガードレール は、エージェントの発話が一連のルールに違反していないかを監視し、即座にレスポンスを遮断するための手段を提供します。これらのガードレールチェックはエージェントのレスポンスの書き起こしに基づいて実行されるため、モデルのテキスト出力が有効化されている必要があります（デフォルトで有効）。

提供されたガードレールは、モデルのレスポンスが返ってくるのと並行して非同期に実行され、たとえば「特定の禁止ワードに言及した」といった事前定義の分類トリガーに基づいてレスポンスを遮断できます。

ガードレールが作動すると、セッションは `guardrail_tripped` イベントを発行します。このイベントには、ガードレールをトリガーした `itemId` を含む `details` オブジェクトも含まれます。

<Code lang="typescript" code={guardrailsExample} />

デフォルトでは、ガードレールは 100 文字ごと、またはレスポンステキストの末尾で実行されます。音声で話すほうが通常は時間がかかるため、ほとんどの場合、ユーザーが聞く前にガードレールが違反を検知できます。

この動作を変更したい場合は、`outputGuardrailSettings` オブジェクトをセッションに渡してください。

<Code lang="typescript" code={guardrailSettingsExample} />

## ターン検出 / 音声アクティビティ検出

Realtime Session は、ユーザーが話していることを自動検知し、組み込みの [Realtime API の音声アクティビティ検出モード](https://platform.openai.com/docs/guides/realtime-vad) を用いて新しいターンをトリガーします。

音声アクティビティ検出モードは、`turnDetection` オブジェクトをセッションに渡すことで変更できます。

<Code lang="typescript" code={turnDetectionExample} />

ターン検出の設定を調整することで、不要な割り込みや無音への対処を調整できます。各設定の詳細は [Realtime API ドキュメント](https://platform.openai.com/docs/guides/realtime-vad) を参照してください

## 割り込み

組み込みの音声アクティビティ検出を使っている場合、エージェントの発話中に話しかけると、自動的にエージェントが発話内容を検知してコンテキストを更新します。同時に `audio_interrupted` イベントも発行されます。これはすべての音声再生を即座に停止するために利用できます（WebSocket 接続の場合のみ適用）。

<Code lang="typescript" code={audioInterruptedExample} />

UI に「停止」ボタンを用意するなど、手動で割り込みを行いたい場合は、`interrupt()` を手動で呼び出せます。

<Code lang="typescript" code={sessionInterruptExample} />

いずれの場合も、Realtime Session はエージェントの生成を中断し、ユーザー に対して話した内容の把握を切り詰め、履歴を更新します。

エージェントに接続するのに WebRTC を使っている場合は、音声出力もクリアされます。WebSocket を使っている場合は、キューに入っている音声の再生を停止する処理を自分で行う必要があります。

## テキスト入力

エージェントにテキスト入力を送るには、`RealtimeSession` の `sendMessage` メソッドを使います。

これは、エージェントとのインターフェースを両方のモダリティで有効にしたい場合や、会話に追加のコンテキストを提供したい場合に役立ちます。

<Code lang="typescript" code={sendMessageExample} />

## 会話履歴の管理

`RealtimeSession` は、`history` プロパティで会話履歴を自動管理します。

これを使って、顧客向けに履歴をレンダリングしたり、追加の処理を行ったりできます。会話の進行中は履歴が常に変化するため、`history_updated` イベントをリッスンできます。

履歴を変更したい場合（メッセージを完全に削除する、書き起こしを更新するなど）は、`updateHistory` メソッドを使用します。

<Code lang="typescript" code={updateHistoryExample} />

### 制限事項

1. 関数ツール呼び出しは、後から更新・変更できません
2. 履歴中のテキスト出力には、書き起こしとテキストモダリティが有効である必要があります
3. 割り込みによって切り詰められたレスポンスには、書き起こしが存在しません

## Delegation through tools

![Delegation through tools](https://cdn.openai.com/API/docs/diagram-speech-to-speech-agent-tools.png)

会話履歴とツール呼び出しを組み合わせることで、より複雑なアクションの実行を別のバックエンド エージェントに委譲し、その結果を ユーザー に返すことができます。

<Code lang="typescript" code={delegationAgentExample} />

以下のコードは サーバー 上で実行されます。この例では Next.js の Server Actions を使用しています。

<Code lang="typescript" code={serverAgentExample} />
